<?xml version='1.0' encoding='UTF-8'?>
<document>
	<title><![CDATA[Transparent encrypted partition unlocking/locking at login/unlogin in Arch Linux]]></title>
	<allow_com>1</allow_com>
	<template><![CDATA[article.php]]></template>
	<chapo><![CDATA[]]></chapo>
	<content><![CDATA[<h3>General overview for the impatients</h3>
<p>In this article I first use cryptsetup to create a regular crypted partition. It needs to have the Linux users password as key to (un)lock the partition. I then use a pretty neat tool called <a href="http://pam-mount.sourceforge.net/">pam_mount</a>. This PAM module enables volume mounting and decrypting at login.</p>

<h3>Pros</h3>
<ul>
  <li>Quite simple to set up and pretty KISS</li>
  <li>Usefulness of encrypted partitions but without the hassle of typing multiple passwords</li>
  <li>Completely transparent for user</li>
</ul>

<h3>Cons</h3>
<ul>
  <li>Using Linux users passwords as uncrypting passphrase may be seen as a flaw in the security of your box because your session password (thus your uncrypting passphrase) is stored in /etc/shadow. This file resides in your root partition which, in this method, must not be crypted. See <a href="#more">the ending comment</a> for a "solution".</li>
  <li>Any user password change will need to be "applied" to this setup. ie removing the password from the luks keyring and adding the new one.</li>
  <li>Will only work for 8 different users as all users passwords must be able to unlock the crypted parition and luks only allows 8 different passwords on its keyring.</li>
</ul>

<p>With these pros and cons, I must say this solution suits me well: a single user on a laptop (with no real sensitive data) who knows how to modify a key on the unlocking keyring when changing the session password. So let's get started.</p>

<h3>Warning</h3>
<ul>
  <li>This howto is made for GDM but with few adaptations it should work for any kind of login manager.</li>
  <li>I use <a href="http://aur.archlinux.org/packages.php?ID=1976">pam_mount</a> which is provided in Arch Linux in <a href="http://aur.archlinux.org/">AUR</a> aka "Not officially supported". Paranoid users should check the PKGBUILD (and the sources ;)).</li>
  <li>For this to work you will have to use the same locking passphrase for your partition as the one used when login to your Linux account.</li>
  <li>In this howto I encrypt my home partition (/dev/sda4) but of course one could unlock/lock any other EXCEPT ROOT.</li>
</ul>

<h3>How to procede</h3>
<p>The first step when crypting a partition is to backup your data as this will erase it all on the target partition. The second step beeing to properly erase all data on the parition (<a href="http://wiki.archlinux.org/index.php/LUKS#Secure_Erasure_of_the_Harddisk_Drive">why and how to do so</a>).<br />
To create a crypted partition, let's be sure that we have all the tools in that intention:<br />
<code><br />
    % pacman -Qs<br />
    local/cryptsetup 1.3.1-2 [0.50 MB] (base)<br />
        Userspace setup tool for transparent encryption<br />
        of block devices using the Linux 2.6 cryptoapi<br />
</code><br />

Cryptsetup belongs to the "base" group in Arch Linux so you should be fine but otherwise just "pacman -Sy cryptsetup". Now let's load the kernel modules depending on your architecture:<br />
<code>modprobe dm-crypt aes-i586</code>
	or<br />
<code>modprobe dm-crypt aes-x86_64</code>
We are then going to create a regular crypted partition. I usually use the following command for that purpose but any other cypher, keysize etc would work. This will ask you for the passphrase you want to use in order to crypt/decrypt your partition. As already said, you NEED to specify here the same password as the one for your Linux account. Change /dev/sda4 with your partition:<br />
<code>cryptsetup -c aes-xts-plain -y -s 512 luksFormat /dev/sda4</code><br />
Also remember that in order for other accounts to still be able to unlock this partition, you need to add all Linux account passwords as keys to unlock the partition. This is made possible through the following command. To be done for all Linux account passwords. Beware that the fist password asked here is the master password you supplied in the previous step:<br />
<code>cryptsetup luksAddKey /dev/sda4</code><br />

Let's open the newly created partition:<br />
<code>cryptsetup luksOpen /dev/sda4 home</code><br />

You should be able to see the mapped device:<br />
<code>ls /dev/mapper/home</code><br />

Create a filesystem on it (such as ReiserFS in this example or any other):<br />
<code>mkfs.reiserfs /dev/mapper/home</code><br />

There! We have an encrypted partition. Now let's get it opened/closed and mounted/unmounted at login time.</p>

<p>For that matter we will need pam_mount from AUR that enables volume mounting at login:<br />
<code>yaourt pam_mount</code><br />

Add the following line to /etc/fstab (notice the "noauto". We just declare it but ask it not to be mounted. Also be sure to specify the filesystem you used instead of 'reiserfs' if required):<br />
<code>/dev/mapper/home  /home  reiserfs  defaults,noauto  0  0</code><br />

Add the following line to /etc/security/pam_mount.conf.xml with the corresponding path:<br />
</code>
    &lt;pam_mount&gt;<br />
        ...<br />
        &lt;volume fstype="crypt" path="/dev/sda4" mountpoint="/home" /&gt;<br />
        ...<br />
    &lt;/pam_mount&gt;<br />
</code><br />

Add the following lines to /etc/pam.d/gdm (and/or /etc/pam.d/login to perform encryption when on console):<br />
<code><br />
    ...<br />
    auth    optional    pam_mount.so<br />
    ...<br />
    session optional    pam_mount.so<br />
    ...
</code><br />

<p>There! Just reboot and enjoy your fully automated encrypted home opening when you log in. If that fails well... then you can't login so there should not be any complaint ;)</p>

<h3>Explanation</h3>
<p>At login time, gdm uses pam to authenticate the user. PAM will check all modules we asked it to "activate" when GDM asks for login (/etc/pam.d/gdm). PAM will thus launch pam_mount which opens and then mounts our encrypted partition.</p>

<h3><a name="more">More</a></h3>
<p>As said in the introduction, using Linux users passwords as uncrypting passphrase may be seen as a security hole because your these passwords are stored in /etc/shadow. This file resides in your root partition which in this method must not be crypted. A possible hardening of this is just to <a href="http://wiki.archlinux.org/index.php/SHA_Passwords">use SHA passwords in /etc/shadows</a>.</p>]]></content>
	<tags><![CDATA[archlinux,security,encryption]]></tags>
</document>
